<template>
    <svg width="300" height="300" viewBox="0 0 300 300" fill="#0079cc">
        <defs>
            <mask :id="maskKey">
                <circle cx="150" cy="150" r="150" style="fill: #fff" />
                <g style="fill: rgb(0 0 0 / 90%)">
                    <path
                        d="M137.608,95.249C140.554,90.124 145.329,86.411 149.89,82.806C154.221,86.653 159.306,90.097 162.131,95.276C161.607,99.769 157.8,104.383 152.97,104.262C148.854,104.302 143.634,105.406 140.715,101.679C139.195,99.863 137.527,97.738 137.608,95.249Z"
                    />
                    <path
                        d="M123.604,88.698C124.061,88.657 124.989,88.577 125.46,88.536C129.509,92.626 132.644,97.549 136.935,101.424C139.168,103.926 143.123,106.751 141.347,110.571C138.805,116.961 133.908,122.019 130.169,127.723C128.393,129.929 126.119,134.072 122.716,132.095C119.582,127.454 117.281,122.248 113.703,117.876C111.847,115.037 108.12,111.782 110.569,108.19C114.335,101.383 118.183,94.361 123.604,88.698Z"
                    />
                    <path
                        d="M173.014,89.626C175.382,86.949 177.965,90.662 179.444,92.438C183.588,98.316 187.96,104.289 190.354,111.109C186.224,118.548 180.615,125.167 176.673,132.781C175.826,132.687 174.144,132.512 173.31,132.431C169.046,126.754 164.875,121.01 160.759,115.239C158.741,112.266 156.427,107.706 159.629,104.693C164.324,99.89 168.844,94.926 173.014,89.626Z"
                    />
                    <path
                        d="M82.494,101.208C91.749,100.482 99.04,107.141 104.367,113.894C110.017,120.122 113.959,127.615 118.142,134.853C121.344,140.112 119.73,146.758 122.662,152.166C126.375,134.261 140.661,121.804 149.204,106.361C151.625,108.607 153.481,111.351 155.284,114.109C163.221,125.409 173.619,136.05 176.122,150.148C176.74,149.946 177.965,149.556 178.583,149.354C179.081,144.754 179.041,139.884 181.341,135.727C187.327,124.427 194.161,113.114 204.439,105.19C208.125,102.338 212.712,101.128 217.339,101.222C214.81,107.423 212.698,113.881 213.102,120.687C213.048,139.198 205.448,157.843 191.336,170.057C186.614,174.577 180.251,177.819 177.628,184.142C184.745,183.254 190.408,178.613 196.246,174.873C208.367,167.138 219.989,158.488 230.428,148.587C238.473,140.906 243.087,130.736 247.069,120.58C250.15,120.284 250.984,123.916 252.356,125.974C257.239,134.436 256.943,144.619 255.826,154.009C253.62,162.887 248.562,171.322 240.867,176.474C230.536,182.945 218.604,186.684 206.47,187.666C202.407,187.895 198.345,188.595 194.645,190.384C195.748,196.464 196.085,203.284 192.022,208.423C186.359,217.799 172.167,220.127 163.786,213.105C158.109,208.181 156.333,200.54 152.419,194.379C150.374,194.809 147.455,193.922 146.338,196.262C142.989,201.858 141.469,208.786 136.182,213.064C130.33,218.149 121.505,218.23 114.752,214.988C110.569,212.526 107.394,208.423 105.551,203.97C103.775,199.545 105.268,194.675 104.313,190.142C101.233,187.908 97.116,188.204 93.525,187.666C81.673,186.832 70.144,183.039 59.934,177.012C51.728,172.008 46.361,163.223 44.114,154.022C43.159,144.619 42.661,134.409 47.531,125.907C48.89,123.876 49.791,120.351 52.818,120.62C55.428,125.84 56.8,131.651 60.069,136.548C68.49,150.35 82.157,159.551 94.843,169.035C103.721,174.349 111.645,182.124 122.097,184.115C119.622,177.765 113.394,174.456 108.618,170.071C94.17,157.533 86.529,138.27 86.852,119.275C87.242,112.912 84.66,107.033 82.494,101.208M110.609,189.536C110.34,197.312 118.465,202.598 125.581,202.181C130.76,201.616 134.608,197.782 138.038,194.218C130.182,188.339 119.878,188.729 110.609,189.536M161.97,193.666C164.243,196.706 166.826,199.746 170.458,201.159C178.422,204.764 189.09,198.536 189.238,189.603C179.982,188.42 170.243,188.917 161.97,193.666Z"
                    />
                </g>
            </mask>
        </defs>
        <circle cx="150" cy="150" r="150" :style="{ fill: background }" />
        <g style="fill: #fff">
            <path
                d="M137.608,95.249C140.554,90.124 145.329,86.411 149.89,82.806C154.221,86.653 159.306,90.097 162.131,95.276C161.607,99.769 157.8,104.383 152.97,104.262C148.854,104.302 143.634,105.406 140.715,101.679C139.195,99.863 137.527,97.738 137.608,95.249Z"
            />
            <path
                d="M123.604,88.698C124.061,88.657 124.989,88.577 125.46,88.536C129.509,92.626 132.644,97.549 136.935,101.424C139.168,103.926 143.123,106.751 141.347,110.571C138.805,116.961 133.908,122.019 130.169,127.723C128.393,129.929 126.119,134.072 122.716,132.095C119.582,127.454 117.281,122.248 113.703,117.876C111.847,115.037 108.12,111.782 110.569,108.19C114.335,101.383 118.183,94.361 123.604,88.698Z"
            />
            <path
                d="M173.014,89.626C175.382,86.949 177.965,90.662 179.444,92.438C183.588,98.316 187.96,104.289 190.354,111.109C186.224,118.548 180.615,125.167 176.673,132.781C175.826,132.687 174.144,132.512 173.31,132.431C169.046,126.754 164.875,121.01 160.759,115.239C158.741,112.266 156.427,107.706 159.629,104.693C164.324,99.89 168.844,94.926 173.014,89.626Z"
            />
            <path
                d="M82.494,101.208C91.749,100.482 99.04,107.141 104.367,113.894C110.017,120.122 113.959,127.615 118.142,134.853C121.344,140.112 119.73,146.758 122.662,152.166C126.375,134.261 140.661,121.804 149.204,106.361C151.625,108.607 153.481,111.351 155.284,114.109C163.221,125.409 173.619,136.05 176.122,150.148C176.74,149.946 177.965,149.556 178.583,149.354C179.081,144.754 179.041,139.884 181.341,135.727C187.327,124.427 194.161,113.114 204.439,105.19C208.125,102.338 212.712,101.128 217.339,101.222C214.81,107.423 212.698,113.881 213.102,120.687C213.048,139.198 205.448,157.843 191.336,170.057C186.614,174.577 180.251,177.819 177.628,184.142C184.745,183.254 190.408,178.613 196.246,174.873C208.367,167.138 219.989,158.488 230.428,148.587C238.473,140.906 243.087,130.736 247.069,120.58C250.15,120.284 250.984,123.916 252.356,125.974C257.239,134.436 256.943,144.619 255.826,154.009C253.62,162.887 248.562,171.322 240.867,176.474C230.536,182.945 218.604,186.684 206.47,187.666C202.407,187.895 198.345,188.595 194.645,190.384C195.748,196.464 196.085,203.284 192.022,208.423C186.359,217.799 172.167,220.127 163.786,213.105C158.109,208.181 156.333,200.54 152.419,194.379C150.374,194.809 147.455,193.922 146.338,196.262C142.989,201.858 141.469,208.786 136.182,213.064C130.33,218.149 121.505,218.23 114.752,214.988C110.569,212.526 107.394,208.423 105.551,203.97C103.775,199.545 105.268,194.675 104.313,190.142C101.233,187.908 97.116,188.204 93.525,187.666C81.673,186.832 70.144,183.039 59.934,177.012C51.728,172.008 46.361,163.223 44.114,154.022C43.159,144.619 42.661,134.409 47.531,125.907C48.89,123.876 49.791,120.351 52.818,120.62C55.428,125.84 56.8,131.651 60.069,136.548C68.49,150.35 82.157,159.551 94.843,169.035C103.721,174.349 111.645,182.124 122.097,184.115C119.622,177.765 113.394,174.456 108.618,170.071C94.17,157.533 86.529,138.27 86.852,119.275C87.242,112.912 84.66,107.033 82.494,101.208M110.609,189.536C110.34,197.312 118.465,202.598 125.581,202.181C130.76,201.616 134.608,197.782 138.038,194.218C130.182,188.339 119.878,188.729 110.609,189.536M161.97,193.666C164.243,196.706 166.826,199.746 170.458,201.159C178.422,204.764 189.09,198.536 189.238,189.603C179.982,188.42 170.243,188.917 161.97,193.666Z"
            />
        </g>
        <g :mask="`url(#${maskKey})`">
            <path
                ref="wave"
                d="M -410 36Q -285 9 ,-160 36Q -35 62,90 36Q 215 9 ,340 36Q 465 62,590 36V 300 H -410 V 36 z"
            ></path>
            <path
                ref="shadow"
                d="M -190 36Q -65 9 ,60 36Q 185 62,310 36Q 435 9 ,560 36Q 685 62,810 36V 300 H -190 V 36 z"
                style="opacity: 0.5"
            ></path>
        </g>
    </svg>
</template>
<script lang="ts">
import { ref, onMounted, defineComponent, onBeforeUnmount, toRef } from 'vue'

export default defineComponent({
    props: {
        percent: {
            type: Number,
            default: 0,
        },
        background: {
            type: String,
            default: '#aaa',
        },
    },
    setup(props) {
        const maskKey = Date.now().toString()
        const wave = ref(null as SVGPathElement | null)
        const shadow = ref(null as SVGPathElement | null)
        let offset = 0
        const create_wave = function (percent: number, swing: number, offset_: number) {
            const width = 300
            const height = 300
            const distance = 220
            const waveLength = 500
            const offset = offset_ % waveLength
            const circle = Math.trunc(width / waveLength) + 2
            let d = 'M ' + (-offset >> 0) + ' ' + (((1 - percent) * height) >> 0)
            let d1 = 'M ' + ((-offset + distance) >> 0) + ' ' + (((1 - percent) * height) >> 0)
            // 每个周期用两个Q
            for (let i = 0; i < circle; i++) {
                d +=
                    'Q ' +
                    ((i * waveLength + waveLength / 4 - offset) >> 0) +
                    ' ' +
                    (((1 - percent) * height - swing) >> 0) +
                    ' ,' +
                    ((i * waveLength + waveLength / 2 - offset) >> 0) +
                    ' ' +
                    (((1 - percent) * height) >> 0)
                d +=
                    'Q ' +
                    ((i * waveLength + (waveLength * 3) / 4 - offset) >> 0) +
                    ' ' +
                    (((1 - percent) * height + swing) >> 0) +
                    ',' +
                    ((i * waveLength + waveLength - offset) >> 0) +
                    ' ' +
                    (((1 - percent) * height) >> 0)

                d1 +=
                    'Q ' +
                    ((i * waveLength + waveLength / 4 - offset + distance) >> 0) +
                    ' ' +
                    (((1 - percent) * height - swing) >> 0) +
                    ' ,' +
                    ((i * waveLength + waveLength / 2 - offset + distance) >> 0) +
                    ' ' +
                    (((1 - percent) * height) >> 0)
                d1 +=
                    'Q ' +
                    ((i * waveLength + (waveLength * 3) / 4 - offset + distance) >> 0) +
                    ' ' +
                    (((1 - percent) * height + swing) >> 0) +
                    ',' +
                    ((i * waveLength + waveLength - offset + distance) >> 0) +
                    ' ' +
                    (((1 - percent) * height) >> 0)
            }
            d += 'V ' + height + ' H ' + (-offset >> 0) + ' V ' + (((1 - percent) * height) >> 0) + ' z'
            d1 += 'V ' + height + ' H ' + ((-offset + distance) >> 0) + ' V ' + (((1 - percent) * height) >> 0) + ' z'
            wave.value && wave.value.setAttribute('d', d)
            shadow.value && shadow.value.setAttribute('d', d1)
        }
        let stopped = false
        const currentProgress = toRef(props, 'percent')
        const run = function () {
            requestAnimationFrame(() => {
                let perc = props.percent
                if (props.percent > currentProgress.value) {
                    perc = currentProgress.value++
                } else if (props.percent < currentProgress.value) {
                    perc = currentProgress.value--
                }
                create_wave(perc / 100, 30, offset++ * 10)
                if (!stopped) {
                    run()
                }
            })
        }
        onMounted(run)
        onBeforeUnmount(() => {
            stopped = true
        })
        return {
            maskKey,
            wave,
            shadow,
        }
    },
})
</script>
